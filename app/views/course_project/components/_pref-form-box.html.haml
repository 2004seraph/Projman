-# This file is a part of Projman, a group project orchestrator and management system,
-# made by Team 5 for the COM3420 module [Software Hut] at the University of Sheffield.

- unique_id = "collapseIssue_#{SecureRandom.hex(4)}" # Generate a unique ID using SecureRandom

.card.issue-card.mb-2.accordion-element
  %a.card-header.d-flex.justify-content-between.align-items-center{"data-bs-toggle" => "collapse",
   href: "##{unique_id}",
   role: "button",
   "data-accordion-toggle" => "",
   "aria-expanded" => "false",
   "aria-controls" => unique_id}
    .d-flex.align-items-center
      %h3.m-0.fs-5.fw-medium Teammate Preference Form
    %i.bi.bi-caret-right-fill
  .collapse{id: unique_id}
    .card-body.pt-1.pb-1
      %h1
      %h1.fs-6.fw-normal= "Please enter the students preferred name and surname."
      %h1.fs-6.fw-normal.fst-italic= "If the student does not appear in the dropdown - make sure you are using the correct name."
      %hr.divider
      = form_with(model: @milestone_response,url: "/projects/#{@current_project.id}/milestone_responses", method: "post", local: true, id: "preference-form") do |form|
        .form-group
          - hidden_fields = {"project_id" => params[:id]}
          %h1.fs-5.fw-semibold Preferred Teammates
          - @yes_mates.times do |i|
            = render 'components/search-with-dropdown',
                form_input_id: "preferred_teammate_#{i}".to_sym,
                form_input_name: "preferred_teammate_#{i}".to_sym,
                data_search_autocomplete_method: defined?(search_student_name_projects_path) ? search_student_name_projects_path : "",
                hidden_fields: hidden_fields
            %h1
          %hr.divider
          %h1.fs-5.fw-semibold Avoided Teammates
          - @no_mates.times do |j|
            = render 'components/search-with-dropdown',
                form_input_id: "avoided_teammate_#{j}".to_sym,
                form_input_name: "avoided_teammate_#{j}".to_sym,
                data_search_autocomplete_method: defined?(search_student_name_projects_path) ? search_student_name_projects_path : "",
                hidden_fields: hidden_fields
            %h1
          %hr.divider
          %button.btn.btn-primary.btn-sm{ type: "submit" } Submit
          %h1

#success-message.alert.alert-success{style: "display: none;"}
  Preference Form submitted successfully!

:javascript
  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('preference-form').addEventListener('submit', function(event) {
      event.preventDefault();

      const form = this;
      const formData = new FormData(form);
      formData.append('milestone_id', #{@pref_form.id})

      fetch(form.action, {
        method: form.method,
        headers: {
          'X-CSRF-Token': document.querySelector("meta[name='csrf-token']").getAttribute("content")
        },
        body: formData
      })
      .then(response => {
        if (response.ok) {
          form.reset();
          document.getElementById('success-message').style.display = 'block';
          setTimeout(function() {
            document.getElementById('success-message').style.display = 'none';
          }, 3000);

          const issueCardElement = document.querySelector('.issue-card');
          if (issueCardElement) {
          issueCardElement.style.display = 'none';
          }
        } else {
          console.error('Error:', response.statusText);
        }
      })
      .catch(error => {
        console.error('Error:', error);
      });
    });
  });